import streamlit as st
import google.generativeai as genai
import os
import time
import random
from dotenv import load_dotenv
from rag_system import retrieve_stones
from stone_dictionary import translate_field

# ========================
# CONFIG
# ========================

load_dotenv()

# ‡∏≠‡πà‡∏≤‡∏ô API key ‡∏à‡∏≤‡∏Å Streamlit Secrets ‡∏Å‡πà‡∏≠‡∏ô
api_key = None

try:
    api_key = st.secrets["GEMINI_API_KEY"]
except Exception:
    api_key = os.getenv("GEMINI_API_KEY")

genai.configure(api_key=api_key)

model = genai.GenerativeModel(
    model_name="models/gemini-2.0-flash"
)


st.title("ü™® AI Stone Advisor")

# ========================
# SESSION STATE
# ========================
if "await_requirements" not in st.session_state:
    st.session_state.await_requirements = False  # ‡∏£‡∏≠ user ‡∏ï‡∏≠‡∏ö ‚Äú‡∏à‡∏∞‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô‡πÅ‡∏ö‡∏ö‡πÑ‡∏´‡∏ô‚Äù
if "last_knowledge_topic" not in st.session_state:
    st.session_state.last_knowledge_topic = None

# ========================
# CHOOSE STONE TYPE
# ========================
stone_choice = st.radio(
    "‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡∏´‡∏¥‡∏ô",
    ["Granite(‡∏´‡∏¥‡∏ô‡πÅ‡∏Å‡∏£‡∏ô‡∏¥‡∏ï)", "Marble(‡∏´‡∏¥‡∏ô‡∏≠‡πà‡∏≠‡∏ô)", "‡πÑ‡∏°‡πà‡πÅ‡∏ô‡πà‡πÉ‡∏à (‡πÉ‡∏´‡πâ‡∏£‡∏∞‡∏ö‡∏ö‡πÄ‡∏•‡∏∑‡∏≠‡∏Å)"],
    horizontal=True
)
choice_lower = stone_choice.lower()
if "granite" in choice_lower:
    stone_type = "granite"
elif "marble" in choice_lower:
    stone_type = "marble"
else:
    stone_type = None

use_gemini = st.toggle("‡πÉ‡∏ä‡πâ AI ‡∏≠‡∏ò‡∏¥‡∏ö‡∏≤‡∏¢ (Gemini)", value=False)

# ========================
# HELPERS
# ========================
def call_gemini_with_retry(model, prompt, max_retries=4):
    for attempt in range(max_retries):
        try:
            return model.generate_content(prompt).text
        except Exception as e:
            msg = str(e)
            if ("429" in msg) or ("Resource exhausted" in msg) or ("ResourceExhausted" in msg):
                time.sleep((2 ** attempt) + random.random())
                continue
            raise
    return None

def render_stone(row):
    stone_type_th = translate_field("stone_type", row.get("stone_type"))
    origin_th = translate_field("origin_country", row.get("origin_country"))
    usage_th = translate_field("indoor_outdoor", row.get("indoor_outdoor"))
    popular_use_th = translate_field("popular_use", row.get("popular_use"))

    price = "-"
    try:
        price = f"{int(float(row.get('price_min'))):,}"
    except Exception:
        pass

    st.markdown(f"""
### ü™® {stone_type_th} ‡∏•‡∏≤‡∏¢ {row.get('stone_name', '-')}

üí∞ **‡∏£‡∏≤‡∏Ñ‡∏≤‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô:** {price} ‡∏ö‡∏≤‡∏ó/‡∏ï‡∏£.‡∏°.  
üåç **‡πÅ‡∏´‡∏•‡πà‡∏á‡∏Å‡∏≥‡πÄ‡∏ô‡∏¥‡∏î:** {origin_th}  
üè† **‡∏Å‡∏≤‡∏£‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô‡∏¢‡∏≠‡∏î‡∏ô‡∏¥‡∏¢‡∏°:** {popular_use_th}  
üå§ **‡πÄ‡∏´‡∏°‡∏≤‡∏∞‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö:** {usage_th}
""")

def is_knowledge_question(text: str) -> bool:
    t = text.lower()
    keywords = ["‡∏ï‡πà‡∏≤‡∏á‡∏Å‡∏±‡∏ô", "‡πÅ‡∏ï‡∏Å‡∏ï‡πà‡∏≤‡∏á", "‡∏Ñ‡∏∑‡∏≠‡∏≠‡∏∞‡πÑ‡∏£", "‡∏Ç‡πâ‡∏≠‡∏î‡∏µ", "‡∏Ç‡πâ‡∏≠‡πÄ‡∏™‡∏µ‡∏¢", "‡∏î‡∏µ‡∏Å‡∏ß‡πà‡∏≤", "‡πÄ‡∏õ‡∏£‡∏µ‡∏¢‡∏ö‡πÄ‡∏ó‡∏µ‡∏¢‡∏ö", "compare"]
    return any(k in t for k in keywords)

def looks_like_granite_vs_marble(text: str) -> bool:
    t = text.lower()
    has_granite = ("‡πÅ‡∏Å‡∏£‡∏ô‡∏¥‡∏ï" in t) or ("granite" in t)
    has_marble = ("‡∏´‡∏¥‡∏ô‡∏≠‡πà‡∏≠‡∏ô" in t) or ("marble" in t)
    return has_granite and has_marble

def fallback_explain_granite_vs_marble():
    return (
        "‡∏™‡∏£‡∏∏‡∏õ‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ï‡πà‡∏≤‡∏á **‡∏´‡∏¥‡∏ô‡πÅ‡∏Å‡∏£‡∏ô‡∏¥‡∏ï vs ‡∏´‡∏¥‡∏ô‡∏≠‡πà‡∏≠‡∏ô** ‡πÅ‡∏ö‡∏ö‡πÄ‡∏Ç‡πâ‡∏≤‡πÉ‡∏à‡∏á‡πà‡∏≤‡∏¢:\n"
        "- **‡∏Ñ‡∏ß‡∏≤‡∏°‡πÅ‡∏Ç‡πá‡∏á/‡∏ó‡∏ô‡∏£‡∏≠‡∏¢**: ‡πÅ‡∏Å‡∏£‡∏ô‡∏¥‡∏ï‡πÇ‡∏î‡∏¢‡∏ó‡∏±‡πà‡∏ß‡πÑ‡∏õ‡∏ó‡∏ô‡∏£‡∏≠‡∏¢‡∏Ç‡∏µ‡∏î‡∏Ç‡πà‡∏ß‡∏ô‡πÅ‡∏•‡∏∞‡πÅ‡∏£‡∏á‡∏Å‡∏£‡∏∞‡πÅ‡∏ó‡∏Å‡∏î‡∏µ‡∏Å‡∏ß‡πà‡∏≤\n"
        "- **‡∏ó‡∏ô‡∏Å‡∏£‡∏î/‡∏Ñ‡∏£‡∏≤‡∏ö**: ‡∏´‡∏¥‡∏ô‡∏≠‡πà‡∏≠‡∏ô‡πÅ‡∏û‡πâ‡∏Å‡∏£‡∏î (‡πÄ‡∏ä‡πà‡∏ô ‡∏°‡∏∞‡∏ô‡∏≤‡∏ß/‡∏ô‡πâ‡∏≥‡∏™‡πâ‡∏°‡∏™‡∏≤‡∏¢‡∏ä‡∏π) ‡∏°‡∏µ‡πÇ‡∏≠‡∏Å‡∏≤‡∏™‡∏î‡πà‡∏≤‡∏á/‡πÄ‡∏õ‡πá‡∏ô‡∏£‡∏≠‡∏¢‡∏Å‡∏±‡∏î‡∏ú‡∏¥‡∏ß‡∏á‡πà‡∏≤‡∏¢‡∏Å‡∏ß‡πà‡∏≤\n"
        "- **‡∏•‡∏ß‡∏î‡∏•‡∏≤‡∏¢**: ‡∏´‡∏¥‡∏ô‡∏≠‡πà‡∏≠‡∏ô‡∏°‡∏±‡∏Å‡∏°‡∏µ‡∏•‡∏≤‡∏¢‡πÄ‡∏™‡πâ‡∏ô (vein) ‡∏™‡∏ß‡∏¢‡∏´‡∏£‡∏π ‡πÅ‡∏ï‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏î‡∏π‡πÅ‡∏•‡∏°‡∏≤‡∏Å‡∏Å‡∏ß‡πà‡∏≤\n"
        "- **‡∏á‡∏≤‡∏ô‡∏Ñ‡∏£‡∏±‡∏ß**: ‡∏ñ‡πâ‡∏≤‡πÄ‡∏ô‡πâ‡∏ô‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô‡∏´‡∏ô‡∏±‡∏Å/‡∏ó‡∏≥‡∏≠‡∏≤‡∏´‡∏≤‡∏£‡∏ö‡πà‡∏≠‡∏¢ ‚Üí ‡∏°‡∏±‡∏Å‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÅ‡∏Å‡∏£‡∏ô‡∏¥‡∏ï; ‡∏ñ‡πâ‡∏≤‡πÄ‡∏ô‡πâ‡∏ô‡∏Ñ‡∏ß‡∏≤‡∏°‡∏™‡∏ß‡∏¢‡∏´‡∏£‡∏π‡πÅ‡∏•‡∏∞‡∏£‡∏±‡∏ö‡∏Å‡∏≤‡∏£‡∏î‡∏π‡πÅ‡∏•‡πÑ‡∏î‡πâ ‚Üí ‡∏´‡∏¥‡∏ô‡∏≠‡πà‡∏≠‡∏ô‡∏Å‡πá‡πÑ‡∏î‡πâ\n"
    )

# ========================
# CHAT INPUT
# ========================
user_input = st.chat_input("‡∏û‡∏¥‡∏°‡∏û‡πå‡∏á‡∏ö / ‡∏Å‡∏≤‡∏£‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô / ‡∏™‡πÑ‡∏ï‡∏•‡πå ‡∏´‡∏£‡∏∑‡∏≠‡∏ñ‡∏≤‡∏°‡∏Ñ‡∏ß‡∏≤‡∏°‡∏£‡∏π‡πâ‡πÑ‡∏î‡πâ‡πÄ‡∏•‡∏¢")

if user_input:
    st.chat_message("user").write(user_input)

    # =========================
    # MODE 1: ‡∏ñ‡πâ‡∏≤‡∏Å‡πà‡∏≠‡∏ô‡∏´‡∏ô‡πâ‡∏≤‡∏ô‡∏µ‡πâ‡πÄ‡∏£‡∏≤‡∏ñ‡∏≤‡∏°‡∏ï‡πà‡∏≠ ‡πÅ‡∏•‡πâ‡∏ß‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏£‡∏≠ requirement
    # =========================
    if st.session_state.await_requirements:
        st.session_state.await_requirements = False  # ‡πÑ‡∏î‡πâ‡∏Ñ‡∏≥‡∏ï‡∏≠‡∏ö‡πÅ‡∏•‡πâ‡∏ß

        retrieved = retrieve_stones(user_input, stone_type=stone_type)

        if retrieved is None or len(retrieved) == 0:
            st.chat_message("assistant").write(
                "‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏´‡∏¥‡∏ô‡∏ó‡∏µ‡πà‡∏≠‡∏¢‡∏π‡πà‡πÉ‡∏ô‡∏á‡∏ö‡∏´‡∏£‡∏∑‡∏≠‡πÄ‡∏á‡∏∑‡πà‡∏≠‡∏ô‡πÑ‡∏Ç‡∏ô‡∏µ‡πâ‡∏Ñ‡∏£‡∏±‡∏ö üôè\n"
                "‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥‡πÉ‡∏´‡πâ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏á‡∏ö ‡∏´‡∏£‡∏∑‡∏≠‡∏õ‡∏£‡∏±‡∏ö‡πÄ‡∏á‡∏∑‡πà‡∏≠‡∏ô‡πÑ‡∏Ç (‡∏Å‡∏≤‡∏£‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô/‡∏™‡πÑ‡∏ï‡∏•‡πå) ‡πÅ‡∏•‡πâ‡∏ß‡∏•‡∏≠‡∏á‡πÉ‡∏´‡∏°‡πà‡∏≠‡∏µ‡∏Å‡∏Ñ‡∏£‡∏±‡πâ‡∏á"
            )
            st.stop()

        # ‡πÅ‡∏™‡∏î‡∏á Top 3
        for _, row in retrieved.iterrows():
            render_stone(row)

        # ‡∏™‡∏£‡∏∏‡∏õ‡πÄ‡∏ä‡∏¥‡∏á‡∏•‡∏∂‡∏Å (‡∏ñ‡πâ‡∏≤‡πÄ‡∏õ‡∏¥‡∏î Gemini)
        if use_gemini:
            context = retrieved.to_string(index=False)
            prompt = f"""
‡∏Ñ‡∏∏‡∏ì‡∏Ñ‡∏∑‡∏≠‡∏ú‡∏π‡πâ‡πÄ‡∏ä‡∏µ‡πà‡∏¢‡∏ß‡∏ä‡∏≤‡∏ç‡∏î‡πâ‡∏≤‡∏ô‡∏´‡∏¥‡∏ô‡∏Å‡πà‡∏≠‡∏™‡∏£‡πâ‡∏≤‡∏á

‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡∏´‡∏¥‡∏ô‡∏ó‡∏µ‡πà‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å: {stone_choice}
‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤:
{user_input}

‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏´‡∏¥‡∏ô‡∏ó‡∏µ‡πà‡∏£‡∏∞‡∏ö‡∏ö‡∏Ñ‡∏±‡∏î‡∏Å‡∏£‡∏≠‡∏á‡∏°‡∏≤:
{context}

‡∏ä‡πà‡∏ß‡∏¢‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ï‡∏±‡∏ß‡∏ó‡∏µ‡πà‡πÄ‡∏´‡∏°‡∏≤‡∏∞‡∏ó‡∏µ‡πà‡∏™‡∏∏‡∏î 1 ‡∏ï‡∏±‡∏ß
‡πÄ‡∏´‡∏ï‡∏∏‡∏ú‡∏•‡∏™‡∏±‡πâ‡∏ô ‡∏Å‡∏£‡∏∞‡∏ä‡∏±‡∏ö ‡∏ä‡∏±‡∏î‡πÄ‡∏à‡∏ô
‡∏Ç‡πâ‡∏≠‡∏î‡∏µ/‡∏Ç‡πâ‡∏≠‡πÄ‡∏™‡∏µ‡∏¢
‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥‡∏Å‡∏≤‡∏£‡∏î‡∏π‡πÅ‡∏•‡∏£‡∏±‡∏Å‡∏©‡∏≤
‡∏ï‡∏≠‡∏ö‡∏†‡∏≤‡∏©‡∏≤‡πÑ‡∏ó‡∏¢
"""
            answer = call_gemini_with_retry(model, prompt)
            if answer:
                st.chat_message("assistant").write(answer)
            else:
                st.chat_message("assistant").write(
                    "Gemini ‡∏ï‡∏¥‡∏î‡πÇ‡∏Ñ‡∏ß‡∏ï‡πâ‡∏≤ (429) ‡πÄ‡∏•‡∏¢‡∏™‡∏£‡∏∏‡∏õ‡πÄ‡∏ä‡∏¥‡∏á‡∏•‡∏∂‡∏Å‡πÉ‡∏´‡πâ‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡∏ä‡∏±‡πà‡∏ß‡∏Ñ‡∏£‡∏≤‡∏ß ‡πÅ‡∏ï‡πà‡∏ú‡∏•‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏î‡πâ‡∏≤‡∏ô‡∏ö‡∏ô‡∏Ñ‡∏∑‡∏≠ Top ‡∏ó‡∏µ‡πà‡πÄ‡∏´‡∏°‡∏≤‡∏∞‡∏™‡∏∏‡∏î‡πÅ‡∏•‡πâ‡∏ß ‚úÖ"
                )
        else:
            st.chat_message("assistant").write(
                "‡πÇ‡∏≠‡πÄ‡∏Ñ ‡πÑ‡∏î‡πâ requirement ‡πÅ‡∏•‡πâ‡∏ß ‚úÖ ‡∏ñ‡πâ‡∏≤‡∏≠‡∏¢‡∏≤‡∏Å‡πÉ‡∏´‡πâ‡∏™‡∏£‡∏∏‡∏õ‡πÄ‡∏ä‡∏¥‡∏á‡∏•‡∏∂‡∏Å ‡πÄ‡∏õ‡∏¥‡∏î‡∏™‡∏ß‡∏¥‡∏ï‡∏ä‡πå ‚Äú‡πÉ‡∏ä‡πâ AI ‡∏≠‡∏ò‡∏¥‡∏ö‡∏≤‡∏¢ (Gemini)‚Äù ‡πÑ‡∏î‡πâ‡πÄ‡∏•‡∏¢"
            )

        st.stop()

    # =========================
    # MODE 2: Knowledge / Comparison
    # =========================
    if is_knowledge_question(user_input) or looks_like_granite_vs_marble(user_input):
        # ‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏Ñ‡∏≥‡∏ï‡∏≠‡∏ö‡∏Ñ‡∏ß‡∏≤‡∏°‡∏£‡∏π‡πâ + ‡∏ñ‡∏≤‡∏°‡∏ï‡πà‡∏≠‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà recommendation
        if use_gemini:
            prompt = f"""
‡∏ï‡∏≠‡∏ö‡∏Ñ‡∏≥‡∏ñ‡∏≤‡∏°‡πÄ‡∏ä‡∏¥‡∏á‡∏Ñ‡∏ß‡∏≤‡∏°‡∏£‡∏π‡πâ‡πÄ‡∏Å‡∏µ‡πà‡∏¢‡∏ß‡∏Å‡∏±‡∏ö‡∏´‡∏¥‡∏ô‡∏Å‡πà‡∏≠‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÄ‡∏õ‡πá‡∏ô‡∏†‡∏≤‡∏©‡∏≤‡πÑ‡∏ó‡∏¢‡πÅ‡∏ö‡∏ö‡πÄ‡∏Ç‡πâ‡∏≤‡πÉ‡∏à‡∏á‡πà‡∏≤‡∏¢

‡∏Ñ‡∏≥‡∏ñ‡∏≤‡∏°: {user_input}

‡∏à‡∏≤‡∏Å‡∏ô‡∏±‡πâ‡∏ô ‚Äú‡∏ñ‡∏≤‡∏°‡∏ï‡πà‡∏≠ 1 ‡∏Ñ‡∏≥‡∏ñ‡∏≤‡∏°‚Äù ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏Å‡πá‡∏ö‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤ ‡πÇ‡∏î‡∏¢‡∏ñ‡∏≤‡∏°‡∏õ‡∏£‡∏∞‡∏°‡∏≤‡∏ì‡∏ß‡πà‡∏≤:
‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô‡πÅ‡∏ö‡∏ö‡πÑ‡∏´‡∏ô (‡∏Ñ‡∏£‡∏±‡∏ß/‡∏û‡∏∑‡πâ‡∏ô/‡∏ú‡∏ô‡∏±‡∏á/‡∏†‡∏≤‡∏¢‡∏ô‡∏≠‡∏Å) ‡∏á‡∏ö‡∏õ‡∏£‡∏∞‡∏°‡∏≤‡∏ì‡πÄ‡∏ó‡πà‡∏≤‡πÑ‡∏´‡∏£‡πà ‡πÅ‡∏•‡∏∞‡∏™‡πÑ‡∏ï‡∏•‡πå‡∏≠‡∏∞‡πÑ‡∏£
‡∏≠‡∏¢‡πà‡∏≤‡∏ñ‡∏≤‡∏°‡∏´‡∏•‡∏≤‡∏¢‡∏Ç‡πâ‡∏≠‡∏¢‡∏≤‡∏ß ‡πÜ ‡πÉ‡∏´‡πâ‡∏ñ‡∏≤‡∏°‡∏™‡∏±‡πâ‡∏ô ‡πÜ ‡πÅ‡∏ï‡πà‡∏Ñ‡∏£‡∏≠‡∏ö‡∏Ñ‡∏•‡∏∏‡∏°
"""
            answer = call_gemini_with_retry(model, prompt)
            if not answer:
                answer = fallback_explain_granite_vs_marble() + "\n\n‡∏≠‡∏¢‡∏≤‡∏Å‡πÄ‡∏≠‡∏≤‡πÑ‡∏õ‡πÉ‡∏ä‡πâ‡∏ó‡∏≥‡∏™‡πà‡∏ß‡∏ô‡πÑ‡∏´‡∏ô‡∏Ñ‡∏£‡∏±‡∏ö (‡∏Ñ‡∏£‡∏±‡∏ß/‡∏û‡∏∑‡πâ‡∏ô/‡∏ú‡∏ô‡∏±‡∏á/‡∏†‡∏≤‡∏¢‡∏ô‡∏≠‡∏Å) ‡πÅ‡∏•‡∏∞‡∏á‡∏ö‡∏õ‡∏£‡∏∞‡∏°‡∏≤‡∏ì‡∏õ‡∏£‡∏∞‡∏°‡∏≤‡∏ì‡πÄ‡∏ó‡πà‡∏≤‡πÑ‡∏´‡∏£‡πà?"
        else:
            # ‡πÑ‡∏°‡πà‡πÉ‡∏ä‡πâ Gemini -> ‡πÉ‡∏ä‡πâ‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à‡∏£‡∏π‡∏õ (‡∏Å‡∏£‡∏ì‡∏µ granite vs marble)
            if looks_like_granite_vs_marble(user_input):
                answer = fallback_explain_granite_vs_marble() + "\n\n‡∏≠‡∏¢‡∏≤‡∏Å‡πÄ‡∏≠‡∏≤‡πÑ‡∏õ‡πÉ‡∏ä‡πâ‡∏ó‡∏≥‡∏™‡πà‡∏ß‡∏ô‡πÑ‡∏´‡∏ô‡∏Ñ‡∏£‡∏±‡∏ö (‡∏Ñ‡∏£‡∏±‡∏ß/‡∏û‡∏∑‡πâ‡∏ô/‡∏ú‡∏ô‡∏±‡∏á/‡∏†‡∏≤‡∏¢‡∏ô‡∏≠‡∏Å) ‡πÅ‡∏•‡∏∞‡∏á‡∏ö‡∏õ‡∏£‡∏∞‡∏°‡∏≤‡∏ì‡∏õ‡∏£‡∏∞‡∏°‡∏≤‡∏ì‡πÄ‡∏ó‡πà‡∏≤‡πÑ‡∏´‡∏£‡πà?"
            else:
                answer = "‡πÑ‡∏î‡πâ‡∏Ñ‡∏£‡∏±‡∏ö üëç ‡∏≠‡∏¢‡∏≤‡∏Å‡πÄ‡∏≠‡∏≤‡πÑ‡∏õ‡πÉ‡∏ä‡πâ‡∏ó‡∏≥‡∏™‡πà‡∏ß‡∏ô‡πÑ‡∏´‡∏ô (‡∏Ñ‡∏£‡∏±‡∏ß/‡∏û‡∏∑‡πâ‡∏ô/‡∏ú‡∏ô‡∏±‡∏á/‡∏†‡∏≤‡∏¢‡∏ô‡∏≠‡∏Å) ‡πÅ‡∏•‡∏∞‡∏á‡∏ö‡∏õ‡∏£‡∏∞‡∏°‡∏≤‡∏ì‡∏õ‡∏£‡∏∞‡∏°‡∏≤‡∏ì‡πÄ‡∏ó‡πà‡∏≤‡πÑ‡∏´‡∏£‡πà ‡πÄ‡∏î‡∏µ‡πã‡∏¢‡∏ß‡∏ú‡∏°‡∏ä‡πà‡∏ß‡∏¢‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥‡πÉ‡∏´‡πâ‡πÄ‡∏´‡∏°‡∏≤‡∏∞‡πÄ‡∏•‡∏¢"

        st.chat_message("assistant").write(answer)

        # ‡∏ï‡∏±‡πâ‡∏á‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏ß‡πà‡∏≤ ‚Äú‡∏£‡∏≠ requirement‚Äù ‡πÉ‡∏ô‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ñ‡∏±‡∏î‡πÑ‡∏õ
        st.session_state.await_requirements = True
        st.stop()

    # =========================
    # MODE 3: Product recommendation (‡∏õ‡∏Å‡∏ï‡∏¥)
    # =========================
    retrieved = retrieve_stones(user_input, stone_type=stone_type)

    if retrieved is None or len(retrieved) == 0:
        st.chat_message("assistant").write(
            "‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏´‡∏¥‡∏ô‡∏ó‡∏µ‡πà‡∏≠‡∏¢‡∏π‡πà‡πÉ‡∏ô‡∏á‡∏ö‡∏´‡∏£‡∏∑‡∏≠‡πÄ‡∏á‡∏∑‡πà‡∏≠‡∏ô‡πÑ‡∏Ç‡∏ô‡∏µ‡πâ‡∏Ñ‡∏£‡∏±‡∏ö üôè\n"
            "‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥‡πÉ‡∏´‡πâ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏á‡∏ö ‡∏´‡∏£‡∏∑‡∏≠‡∏õ‡∏£‡∏±‡∏ö‡πÄ‡∏á‡∏∑‡πà‡∏≠‡∏ô‡πÑ‡∏Ç (‡∏Å‡∏≤‡∏£‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô/‡∏™‡πÑ‡∏ï‡∏•‡πå) ‡πÅ‡∏•‡πâ‡∏ß‡∏•‡∏≠‡∏á‡πÉ‡∏´‡∏°‡πà‡∏≠‡∏µ‡∏Å‡∏Ñ‡∏£‡∏±‡πâ‡∏á"
        )
        st.stop()

    for _, row in retrieved.iterrows():
        render_stone(row)

    if use_gemini:
        context = retrieved.to_string(index=False)
        prompt = f"""
‡∏Ñ‡∏∏‡∏ì‡∏Ñ‡∏∑‡∏≠‡∏ú‡∏π‡πâ‡πÄ‡∏ä‡∏µ‡πà‡∏¢‡∏ß‡∏ä‡∏≤‡∏ç‡∏î‡πâ‡∏≤‡∏ô‡∏´‡∏¥‡∏ô‡∏Å‡πà‡∏≠‡∏™‡∏£‡πâ‡∏≤‡∏á

‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡∏´‡∏¥‡∏ô‡∏ó‡∏µ‡πà‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å: {stone_choice}
‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤:
{user_input}

‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏´‡∏¥‡∏ô‡∏ó‡∏µ‡πà‡∏£‡∏∞‡∏ö‡∏ö‡∏Ñ‡∏±‡∏î‡∏Å‡∏£‡∏≠‡∏á‡∏°‡∏≤:
{context}

‡∏ä‡πà‡∏ß‡∏¢‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ï‡∏±‡∏ß‡∏ó‡∏µ‡πà‡πÄ‡∏´‡∏°‡∏≤‡∏∞‡∏ó‡∏µ‡πà‡∏™‡∏∏‡∏î 1 ‡∏ï‡∏±‡∏ß
‡πÄ‡∏´‡∏ï‡∏∏‡∏ú‡∏•‡∏™‡∏±‡πâ‡∏ô ‡∏Å‡∏£‡∏∞‡∏ä‡∏±‡∏ö ‡∏ä‡∏±‡∏î‡πÄ‡∏à‡∏ô
‡∏Ç‡πâ‡∏≠‡∏î‡∏µ/‡∏Ç‡πâ‡∏≠‡πÄ‡∏™‡∏µ‡∏¢
‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥‡∏Å‡∏≤‡∏£‡∏î‡∏π‡πÅ‡∏•‡∏£‡∏±‡∏Å‡∏©‡∏≤
‡∏ï‡∏≠‡∏ö‡∏†‡∏≤‡∏©‡∏≤‡πÑ‡∏ó‡∏¢
"""
        answer = call_gemini_with_retry(model, prompt)
        if answer:
            st.chat_message("assistant").write(answer)
        else:
            st.chat_message("assistant").write(
                "Gemini ‡∏ï‡∏¥‡∏î‡πÇ‡∏Ñ‡∏ß‡∏ï‡πâ‡∏≤ (429) ‡πÄ‡∏•‡∏¢‡∏™‡∏£‡∏∏‡∏õ‡πÄ‡∏ä‡∏¥‡∏á‡∏•‡∏∂‡∏Å‡πÉ‡∏´‡πâ‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡∏ä‡∏±‡πà‡∏ß‡∏Ñ‡∏£‡∏≤‡∏ß ‡πÅ‡∏ï‡πà‡∏ú‡∏•‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏î‡πâ‡∏≤‡∏ô‡∏ö‡∏ô‡∏Ñ‡∏∑‡∏≠ Top ‡∏ó‡∏µ‡πà‡πÄ‡∏´‡∏°‡∏≤‡∏∞‡∏™‡∏∏‡∏î‡πÅ‡∏•‡πâ‡∏ß ‚úÖ"
            )





